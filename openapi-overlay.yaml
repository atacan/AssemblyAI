# OpenAPI Overlay for AssemblyAI
# This file allows you to make manual corrections to the OpenAPI specification
# without modifying the original file. The bootstrapper will apply this overlay
# on top of the cleaned openapi.yaml file.
#
# For overlay syntax, see: https://github.com/OAI/Overlay-Specification

overlay: 1.0.0
info:
  title: AssemblyAI API Overlay
  version: 1.0.0

# Example actions (uncomment and modify as needed):
# actions:
#   # Make a field required
#   - target: "$.components.schemas.User"
#     update:
#       required:
#         - user_id
#         - email
#
#   # Add a missing property
#   - target: "$.components.schemas.Product"
#     update:
#       properties:
#         newField:
#           type: string
#           description: "A field that was missing in the original spec"
#
#   # Fix an incorrect type
#   - target: "$.components.schemas.Order.properties.total"
#     update:
#       type: number
#       format: double
#
#   # Remove a deprecated field
#   - target: "$.components.schemas.LegacyModel.properties.oldField"
#     remove: true

actions:
  # Remove existing Transcript required field
  - target: "$.components.schemas.Transcript.required"
    remove: true

  # Update Transcript schema required fields and additionalProperties
  - target: "$.components.schemas.Transcript"
    update:
      required:
        - audio_url
        - auto_highlights
        - id
        - redact_pii
        - status
        - summarization
        - webhook_auth
      additionalProperties: true

  # Remove existing ContentSafetyLabelsResult required field
  - target: "$.components.schemas.ContentSafetyLabelsResult.required"
    remove: true

  # Update ContentSafetyLabelsResult schema required fields
  - target: "$.components.schemas.ContentSafetyLabelsResult"
    update:
      required:
        - status
        - results
        - summary
        - severity_score_summary

  # Remove required from TopicDetectionModelResult schema
  - target: "$.components.schemas.TopicDetectionModelResult.required"
    remove: true

  # Remove existing TranscriptWord required field
  - target: "$.components.schemas.TranscriptWord.required"
    remove: true

  # Update TranscriptWord schema required fields
  - target: "$.components.schemas.TranscriptWord"
    update:
      required:
        - confidence
        - start
        - end
        - text

  # Remove existing TranscriptSentence required field
  - target: "$.components.schemas.TranscriptSentence.required"
    remove: true

  # Update TranscriptSentence schema required fields
  - target: "$.components.schemas.TranscriptSentence"
    update:
      required:
        - text
        - start
        - end
        - confidence
        - words

  # Add text/html content type to subtitle endpoint response
  - target: "$.paths./v2/transcript/{transcript_id}/{subtitle_format}.get.responses.200.content"
    update:
      text/html:
        schema:
          type: string

  # Add UnprocessableContent response definition to components
  - target: "$.components.responses"
    update:
      UnprocessableContent:
        description: Bad request
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Error"

  # Add 422 response to all operations in all paths
  - target: "$.paths.*.*.responses"
    update:
      '422':
        $ref: '#/components/responses/UnprocessableContent'

  # Add text/plain content type to all response definitions
  - target: "$.components.responses.*.content"
    update:
      text/plain:
        schema:
          type: string

  # Fix expected_languages in TranscriptOptionalParams - remove incorrect 'objects' field
  - target: "$.components.schemas.TranscriptOptionalParams.properties.language_detection_options.properties.expected_languages.objects"
    remove: true

  # Fix expected_languages in TranscriptOptionalParams - add correct 'items' field
  - target: "$.components.schemas.TranscriptOptionalParams.properties.language_detection_options.properties.expected_languages"
    update:
      items:
        type: string

  # Fix expected_languages in Transcript - remove incorrect 'objects' field
  - target: "$.components.schemas.Transcript.properties.language_detection_options.properties.expected_languages.objects"
    remove: true

  # Fix expected_languages in Transcript - add correct 'items' field
  - target: "$.components.schemas.Transcript.properties.language_detection_options.properties.expected_languages"
    update:
      items:
        type: string

  # Remove existing ContentSafetyLabelsResult required field, because it comes as `{}`
  - target: "$.components.schemas.ContentSafetyLabelsResult.required"
    remove: true

  # Add the streaming yaml file content https://github.com/AssemblyAI/assemblyai-api-spec/blob/main/streaming-token.yml
  ## We renamed the Error schema to StreamingError, and commented out the `security:` section. Do the same when updating this.
  - target: "$.paths"
    update:
      /v3/token:
        get:
          summary: Generate temporary streaming token
          description: |
            Generates a temporary authentication token for use with streaming services.
          operationId: generateStreamingToken
          x-fern-sdk-group-name: Streaming API
          x-fern-sdk-method-name: generateStreamingToken
          # security:
          #   - apiKey: []
          parameters:
            - name: expires_in_seconds
              in: query
              description: |
                The desired expiration time for the token in seconds.
              required: true
              schema:
                type: integer
                minimum: 1
                maximum: 600
                example: 60
            - name: max_session_duration_seconds
              in: query
              description: |
                The desired maximum duration for the session started using this token in seconds.
              required: false
              schema:
                type: integer
                minimum: 60
                maximum: 10800
                example: 600
                default: 10800
          responses:
            "200":
              description: Successfully generated temporary token
              content:
                application/json:
                  schema:
                    type: object
                    required:
                      - token
                      - expires_in_seconds
                    properties:
                      token:
                        type: string
                        description: The temporary authentication token
                        example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                      expires_in_seconds:
                        type: integer
                        description: |
                          The actual expiration time of the token in seconds.
                        example: 60
            "401":
              description: Unauthorized - Invalid or missing API key
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/StreamingTokenError"
            "400":
              description: Bad Request - Invalid parameters
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/StreamingTokenError"
            "429":
              description: Too Many Requests - Rate limit exceeded
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/StreamingTokenError"
            "500":
              description: Internal Server Error
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/StreamingTokenError"
  - target: "$.components.schemas"
    update:
      StreamingTokenError:
        type: object
        required:
          - error
        properties:
          error:
            type: string
            description: Error message describing what went wrong
          code:
            type: string
            description: Error code for programmatic handling
          details:
            type: object
            description: Additional error details if available
